<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBDC Manager Sim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(120deg, #4f8cff 0%, #7fffd4 50%, #ff7ecb 100%);
        }
        .indicator-bar-bg {
            background-color: #e0e0e0;
            border-radius: 0.25rem;
            overflow: hidden;
            height: 20px;
        }
        .indicator-bar {
            height: 100%;
            transition: width 0.3s ease-in-out;
            text-align: center;
            color: white;
            font-size: 0.75rem;
            line-height: 20px;
        }
        .feedback-text {
            font-size: 0.75rem;
            color: #718096; /* text-gray-600 */
            margin-top: 0.25rem; /* mt-1 */
            min-height: 35px; 
        }
        .option-button {
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
        }
        /* Custom styles for indicator colors */
        .usage-bar-fill { background-color: #4CAF50; /* Green */ }
        .resilience-bar-fill { background-color: #66BB6A; /* Lighter Green for Resilience */ }
        .security-bar-fill { background-color: #2196F3; /* Blue for Security */ }
        .budget-bar-fill { background-color: #FFD600; /* Yellow for Budget */ }
        .privacy-bar-fill { background-color: #a855f7; /* Purple for Privacy */ }
        .reputation-bar-fill { background-color: #FF6B35; /* Orange for Reputation */ }

        /* Character SVG style */
        .character-svg {
            width: 56px;
            height: 56px;
            fill: currentColor; 
            color: #4A5568; /* text-gray-700 */
        }
        /* Highlight style for indicators on option hover */
        .indicator-highlight {
            border-color: #2563eb; /* blue-600 */
            background-color: #eff6ff; /* blue-50 */
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        .restart-button {
            transition: background-color 0.2s ease;
        }
        .indicator-card {
            border: 2px solid transparent;
            transition: border-color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-start min-h-screen p-1">

    <div class="bg-white p-0 rounded-2xl shadow-2xl w-full max-w-[1400px] max-h-[95vh] my-auto flex flex-row justify-between overflow-hidden">
        <div class="flex-[2_2_0%] flex flex-col p-6 min-w-0">
            <header class="mb-3">
                <h1 class="text-3xl font-bold text-gray-800 mb-1 text-left">CBDC Manager Simulator</h1>
                <div id="character-area" class="mb-3 flex items-center">
                    <svg class="character-svg" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <p id="character-name" class="ml-3 text-xl font-semibold text-gray-700">Manager Von Tokenstrudel, CBDC Chief</p>
                </div>
            </header>

            <div id="indicators-container" class="grid grid-cols-3 gap-4 mb-4">
                <!-- First row: Usage, Reputation, Budget -->
                <div id="usage-indicator-card" class="indicator-card p-3 rounded-lg shadow"></div>
                <div id="reputation-indicator-card" class="indicator-card p-3 rounded-lg shadow"></div>
                <div id="budget-indicator-card" class="indicator-card p-3 rounded-lg shadow"></div>
                <!-- Second row: Resilience, Security, Privacy -->
                <div id="resilience-indicator-card" class="indicator-card p-3 rounded-lg shadow"></div>
                <div id="security-indicator-card" class="indicator-card p-3 rounded-lg shadow"></div>
                <div id="privacy-indicator-card" class="indicator-card p-3 rounded-lg shadow"></div>
            </div>

            <div id="card-display-area" class="bg-slate-50 p-3 rounded-xl shadow-md mb-3 min-h-[75px] flex flex-col justify-center items-center text-center overflow-auto w-full max-w-full mx-auto">
                <p id="situation-text" class="text-gray-700 text-base">Welcome, Manager! Get ready for your first dilemma.</p>
            </div>

            <div id="options-area" class="flex flex-col sm:flex-row justify-around gap-3 mb-3">
                <button id="option1-button" class="option-button bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 text-sm rounded-xl shadow hover:shadow-lg hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 w-full sm:w-1/2 max-w-2xl flex-grow">Option 1</button>
                <button id="option2-button" class="option-button bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 text-sm rounded-xl shadow hover:shadow-lg hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 w-full sm:w-1/2 max-w-2xl flex-grow">Option 2</button>
            </div>

            <div id="message-area" class="mb-3 text-center text-lg font-bold text-indigo-600 min-h-[26px]"></div>

            <div class="mt-3 text-center flex justify-center w-full">
                <button id="restart-button" class="restart-button bg-gray-700 hover:bg-gray-800 text-white font-semibold py-1 px-4 text-base rounded-xl shadow focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 w-full max-w-xs sm:w-auto">
                    Restart Game
                </button>
            </div>
        </div>

        <aside class="w-[310px] bg-slate-100 border-l border-slate-300 flex flex-col items-center justify-center p-6 min-h-full shadow-inner">
            <div id="features-container" class="w-full">
                <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">CBDC Features</h2>
                <ul id="features-list" class="grid grid-cols-2 gap-2 w-full items-center justify-items-center"></ul>
                <div id="features-goal" class="text-base text-indigo-600 mt-3 text-center w-full"></div>
            </div>
            <div id="achievements-container" class="w-full mt-6">
                <h2 class="text-lg font-semibold text-yellow-700 mb-3 text-center">Achievements Unlocked</h2>
                <ul id="achievements-list" class="grid grid-cols-1 gap-2 w-full items-center justify-items-center"></ul>
            </div>
        </aside>
    </div>

    <script>
        // --- GAME CONFIGURATION ---
        const INDICATOR_SCALE_LABELS = ["Very Low", "Low", "Medium Low", "Medium", "Medium High", "High", "Extreme"]; // 0 to 6
        const MAX_INDICATOR_VALUE = INDICATOR_SCALE_LABELS.length - 1; // Should be 6

        // --- GAME STATE ---
        let indicators = {}; // Initialized in initializeGame
        let currentCardIndex = -1;
        let deck = [];
        // Track played cards and chosen options
        let playedCardIds = [];
        let chosenOptionKeys = [];
        let chosenOptions = []; // Track which option was chosen for each card
        // Track implemented features
        let features = {
            offline: false,
            postquantum: false,
            interoperability: false,
            dispute: false,
            programmable: false,
            recovery: false
        };
        // Track achievements
        let achievements = {
            offlineSpace: false, // ISS vending machine (card 25, option 0)
            helicopterMoney: false, // Helicopter money (card 26, option 0)
            badIdea: false, // Bad Idea (card 2, option 0)
            nuclearProof: false // Nuclear-proof backup (card 71, option 0)
        };
        const FEATURES_META = [
            { key: 'offline', label: 'Offline CBDC', icon: 'üì¥' },
            { key: 'postquantum', label: 'Post-Quantum Security', icon: 'üîí' },
            { key: 'interoperability', label: 'Interoperability Protocol', icon: 'üîó' },
            { key: 'dispute', label: 'Dispute Mechanism', icon: '‚öñÔ∏è' },
            { key: 'programmable', label: 'Programmable Money', icon: 'ü§ñ' },
            { key: 'recovery', label: 'Recovery Site', icon: 'üè•' },
            { key: 'fraud_scoring_tool', label: 'Fraud Scoring Tool', icon: 'üïµÔ∏è' }
        ];

        // --- DOM ELEMENTS ---
        const indicatorsContainer = document.getElementById('indicators-container');
        const situationText = document.getElementById('situation-text');
        const option1Button = document.getElementById('option1-button');
        const option2Button = document.getElementById('option2-button');
        const messageArea = document.getElementById('message-area');
        const characterNameElement = document.getElementById('character-name');
        const restartButton = document.getElementById('restart-button');
        const featuresContainer = document.getElementById('features-container');
        const featuresList = document.getElementById('features-list');
        const featuresGoal = document.getElementById('features-goal');

        // --- CARD DATA (23 Cards) ---
        const cardsData = [
            // Card 1 - UPDATED
            {
                id: 1,
                situation: "A viral TikTok trend shows teens using the CBDC to buy virtual llamas. It's boosting adoption but looks... silly.",
                options: [
                    { text: "Embrace the meme! It's organic marketing.", effects: { usage: +1, reputation: +1 }, feedback: { usage: "Llama campaign = viral hit! Usage up.", reputation: "Public sees CBDC as fun and approachable. Reputation up."}},
                    { text: "Quietly issue a 'clarification' that CBDC is for serious transactions.", effects: { reputation: -1 }, feedback: { reputation: "CBDC seen as stuffy and out of touch. Reputation down."}}
                ]
            },
            // Card 2
            {
                id: 2,
                situation: "A shadowy online figure offers to 'stress-test' our security for a small fee (paid in a cryptocurrency).",
                options: [
                    { text: "Sure, what could go wrong? Valuable insights!", effects: { security: -2, resilience: -1, budget: -1 }, feedback: { security: "Security way down.", resilience: "Hacker compromises the system. Resilience down.", budget: "Hacker stole money! Budget down." }, achievement: 'badIdea' },
                    { text: "Politely decline", effects: { resilience: +1 }, feedback: { resilience: "Declining unsolicited, suspicious offers shows prudence. Resilience up."}}
                ]
            },
            // Card 3
            {
                id: 3,
                situation: "Elderly citizens are struggling with multi-factor authentication for the CBDC wallet. #CBDCisAgeist is trending.",
                options: [
                    { text: "Launch 'Silver Surfers' CBDC education program with simplified guides.", effects: { usage: +1 }, feedback: { usage: "Seniors' adoption increased slightly."}},
                    { text: "Statement: 'Security is paramount. We offer workshops, but users must adapt to new tech.'", effects: { usage: -1, security: +1 }, feedback: { usage: "Some users gave up. Usage down.", security: "Fewer vulnerable accounts. Security up."}}
                ]
            },
            // Card 4 - UPDATED
            {
                id: 4,
                situation: "A foreign authority claims‚Äîwithout evidence‚Äîthat your CBDC is being used by their citizens to buy forbidden snacks and fund underground hamster racing leagues. The media is watching closely. How do you respond?",
                options: [
                    { text: "Accuse them of 'digital protectionism' to protect our users' freedom to transact.", effects: { usage: +1, resilience: -1 }, feedback: { usage: "A surprising number of users rally behind the cause of free-flowing digital commerce. Usage up.", resilience: "The other jurisdiction retaliates with sophisticated hacking attempts. Resilience down."}},
                    { text: "Implement geo-fencing to limit usage from that jurisdiction.", effects: { usage: -1, budget: -1 }, feedback: { usage: "Not servicing users in that region angers them. Usage down.", budget: "Implementing and maintaining these controls is costly."}}
                ]
            },
            // Card 5 - UPDATED
            {
                id: 5,
                situation: "A minor bug briefly allowed users to see transaction details of others (it's fixed!). The memes about 'CBDC_SpyMode' are relentless.",
                options: [
                    { text: "Lean into it with a 'Privacy is a journey!' PR campaign.", effects: { privacy: -2, reputation: -1 }, feedback: { privacy: "The casual approach to privacy concerns makes users worry about their data security. Privacy down.", reputation: "The casual approach makes the CBDC manager appear unserious. Reputation down."}},
                    { text: "Issue stern warning about data privacy, offer bug bounty for future finds, and conduct a full audit.", effects: { privacy: +1, budget: -1 }, feedback: { privacy: "Strong privacy stance and proactive security measures reassure users. Privacy up.", budget: "Bug bounties and audits aren't free. Budget down."}}
                ]
            },
            // Card 6
            {
                id: 6,
                situation: "An influential environmental group claims your CBDC uses 'more energy than Bitcoin!' The media is having a field day.",
                options: [
                    { text: "Launch a counter-PR blitz with complex charts and expert testimonials proving them wrong.", effects: { reputation: +1 }, feedback: { reputation: "Successfully defended against false claims. Reputation up."}},
                    { text: "Commission an independent audit to address the energy claims.", effects: { resilience: +1 }, feedback: { resilience: "Independent audit discovers a bug and helps patch it."}}
                ]
            },
            // Card 7 - UPDATED
            {
                id: 7,
                situation: "Rural communities demand robust offline CBDC payments, but developing secure offline capabilities is complex and resource-intensive.",
                options: [
                    { text: "Invest heavily in developing and deploying secure offline mode. Financial Inclusion is key!", effects: { usage: +2, security: -1, budget: -2, resilience: +1 }, feedback: { usage: "Offline mode is a hit in remote areas! Usage way up.", security: "Less control over offline transactions. Security down.", budget: "R&D and deployment for offline mode is very expensive. Budget down.", resilience: "Offline capabilities improve system robustness. Resilience up." }, chosenKey: 'offline_invest' },
                    { text: "Announce offline payments as a 'long-term goal' while focusing on current system stability.", effects: { usage: -1, budget: +1, resilience: -1 }, feedback: { usage: "Rural users feel their specific needs are ignored for now. Usage down.", budget: "Avoided a massive R&D expenditure for now. Budget up.", resilience: "System stability is compromised by lack of offline capabilities. Resilience down." }, chosenKey: 'offline_delay' }
                ]
            },
            // Card 8
            {
                id: 8,
                situation: "A popular, but controversial, financial influencer has started promoting your CBDC on their own initiative. They were just arrested for unrelated securities fraud.",
                options: [
                    { text: "Issue a statement clarifying the CBDC project has no official relationship with the influencer.", effects: { reputation: +1 }, feedback: { reputation: "Quickly distancing from scandal protects CBDC's reputation. Reputation up."}},
                    { text: "Stay silent and hope it blows over quickly.", effects: { reputation: -1 }, feedback: { reputation: "Silence is interpreted as guilt by association. Reputation down."}}
                ]
            },
            // Card 8.5 - Follow-up to Card 8 (Silence Option)
            {
                id: 8.5,
                prerequisite: { cardId: 8, optionIndex: 1 }, // Only if player chose "Stay silent" in Card 8
                situation: "The media has dug deeper into the influencer scandal and found old social media posts where they mentioned 'working with the CBDC team.' Your continued silence is being interpreted as confirmation of a relationship.",
                options: [
                    { text: "Finally issue a statement: 'We have never had any official relationship with this individual.'", effects: { reputation: -1 }, feedback: { reputation: "Delayed response looks like damage control. Reputation down."}},
                    { text: "Continue staying silent and let it blow over.", effects: { reputation: -2 }, feedback: { reputation: "Silence is now seen as admission of guilt. Reputation way down."}}
                ]
            },
            // Card 9
            {
                id: 9,
                situation: "News speculates CBDC could enable 'programmable money' to restrict purchases (e.g., 'no more than 2 donuts per week'). People are spooked.",
                options: [
                    { text: "Firm statement: 'Our CBDC will NEVER have such features. It's digital cash, period!'", effects: { usage: +1, privacy: +1, reputation: +1 }, feedback: { usage: "Public reassured... for now. Usage up.", privacy: "Strong privacy stance reassures users.", reputation: "Clear, firm stance reassures the public. Reputation up."}},
                    { text: "Hint at 'potential future benefits for public health and responsible spending' in a carefully worded policy paper.", effects: { usage: -1, privacy: -1, reputation: -2 }, feedback: { usage: "Conspiracy theories explode! Usage plummets.", privacy: "Hints at restrictions spark privacy concerns.", reputation: "Conspiracy theories damage public trust. Reputation down."}}
                ]
            },
            // Card 9.5 - Follow-up to Card 9 (Programmable Money Option)
            {
                id: 9.5,
                prerequisite: { cardId: 9, optionIndex: 1 }, // Only if player chose "Hint at programmable money" in Card 9
                situation: "Your legal counsel comes to you and speaks angrily about a guy they keep referring to as 'Big Brother.' You're not entirely sure what they're talking about, but they seem very concerned about programmable money enabling this person.",
                options: [
                    { text: "The lawyer has a point. Renounce.", effects: { privacy: +1, security: +1 }, feedback: { privacy: "Avoiding programmable money protects user privacy. Privacy up.", security: "Simpler system reduces attack surface. Security up."}},
                    { text: "Implement programmable money despite the risks. Innovation requires boldness!", effects: {}, feedback: {}, chosenKey: 'programmable_money' }
                ]
            },
            // Card 10
            {
                id: 10,
                situation: "A consortium of private stablecoin issuers wants a pilot for fungibility with your CBDC. They still exhibit high fraud.",
                options: [
                    { text: "Agree to a pilot collaboration. Innovation requires openness!", effects: { usage: +1 }, feedback: { usage: "More transaction options! Usage up."}},
                    { text: "Decline for now.", effects: { security: +1 }, feedback: { security: "Avoiding high-fraud stablecoins protects system security. Security up."}}
                ]
            },
            // Card 10.5 - Revenue Sharing Demands
            {
                id: 10.5,
                situation: "Financial intermediaries are asking for a subsidy coming from central bank income. They claim they're doing most of the work and deserve a higher earning for distributing it.",
                options: [
                    { text: "Accept to subsidize banks.", effects: { budget: -1, usage: +1 }, feedback: { budget: "Higher revenue sharing reduces our income. Budget down.", usage: "Intermediaries are more motivated to promote CBDC. Usage up."}},
                    { text: "Keep current terms.", effects: { budget: +1, reputation: -1 }, feedback: { budget: "Maintaining current terms preserves our revenue. Budget up.", reputation: "Intermediaries are frustrated with the inflexible terms. Reputation down."}}
                ]
            },
            // Card 11
            {
                id: 11,
                situation: "An escape room company launches a 'Hack the CBDC Central Bank' room. It's surprisingly accurate in its portrayal of potential vulnerabilities.",
                options: [
                    { text: "Send a cease and desist letter. This is a security risk and misrepresents our robustness!", effects: { reputation: -1 }, feedback: { reputation: "Public sees it as censorship or insecurity. Reputation down."}},
                    { text: "Secretly send your security team to play the escape room. Free (and fun) penetration testing!", effects: { resilience: +1, security: +1 }, feedback: { resilience: "Their insights actually helped patch a minor theoretical flaw! Resilience up.", security: "Identified and addressed a potential weakness. Security up."}}
                ]
            },
            // Card 12
            {
                id: 12,
                situation: "A mega-popular pop star declares your CBDC 'the future of fan engagement'; all their concert tickets and merch will ONLY be available via CBDC.",
                options: [
                    { text: "Ride the wave! This is huge for adoption and mainstream visibility!", effects: { usage: +1, reputation: +1, resilience: -1 }, feedback: { usage: "Pop star endorsement brings new users. Usage up.", reputation: "Mainstream visibility improves public perception. Reputation up.", resilience: "System strains under sudden, massive load. Resilience down."}},
                    { text: "Do nothing. Let the pop star and fans do their thing.", effects: {}, feedback: {}}
                ]
            },
            // Card 12.5 - Follow-up to Card 12 (Ride the Wave Option)
            {
                id: 12.5,
                prerequisite: { cardId: 12, optionIndex: 0 }, // Only if player chose "Ride the wave" in Card 12
                situation: "The pop star's next concert sells out in minutes, causing a massive spike in CBDC transactions. Your system is struggling to handle the load, and some fans are getting error messages.",
                options: [
                    { text: "Apologize publicly and commit to improving system resilience.", effects: { resilience: +1, budget: -1 }, feedback: { resilience: "Commitment to resilience improvements strengthens the system. Resilience up.", budget: "Infrastructure improvements are costly. Budget down."}},
                    { text: "Blame the pop star for not coordinating with you properly.", effects: { reputation: -1, usage: -1 }, feedback: { reputation: "Public blames you for the technical issues. Reputation down.", usage: "Some fans switch to other payment methods. Usage down."}}
                ]
            },
            // Card 13 - UPDATED
            {
                id: 13,
                situation: "Financial intermediaries are asking which cryptography standard to use for the CBDC system. They're debating between the cheapest standard or post-quantum cryptography.",
                options: [
                    { text: "Mandate post-quantum cryptography for future-proof security.", effects: { resilience: +1, security: +2, budget: -1 }, feedback: { resilience: "Future-proof security measures strengthen system resilience. Resilience up.", security: "Advanced cryptography makes fraud much harder. Security up.", budget: "Post-quantum cryptography is expensive to implement. Budget down." }, chosenKey: 'crypto_postquantum' },
                    { text: "Use the cheapest standard to keep costs down.", effects: { security: -2, budget: +1 }, feedback: { security: "Basic cryptography is more vulnerable to attacks. Security down.", budget: "Cheaper standard saves on implementation costs. Budget up." }, chosenKey: 'crypto_cheap' }
                ]
            },
            // Card 13.5 - Post-Quantum Implementation Delays (Follow-up to Card 13 Option 1)
            {
                id: 13.5,
                prerequisite: { cardId: 13, optionIndex: 0 }, // Only if player chose post-quantum cryptography
                situation: "The post-quantum cryptography implementation is behind schedule. Financial intermediaries are complaining about the complexity and asking for an extension. The current deadline is causing system integration issues.",
                options: [
                    { text: "Grant a one year extension to ensure proper integration.", effects: { resilience: +1, security: -1 }, feedback: { resilience: "Extension allows for proper integration and testing. Resilience up.", security: "Delayed implementation leaves system vulnerable longer. Security down."}},
                    { text: "Stick to the deadline - security can't wait.", effects: { security: +1, resilience: -1 }, feedback: { security: "Meeting deadline ensures security is implemented on time. Security up.", resilience: "Rushed integration causes system instability. Resilience down."}}
                ]
            },
            // Card 14 - UPDATED
            {
                id: 14,
                prerequisite: { chosenKey: 'programmable_money' },
                situation: "A government department wants to issue official documents (like fishing licenses or professional certifications) as unique digital tokens on a private instance of the CBDC ledger.",
                options: [
                    { text: "Great idea! Showcases versatility and efficiency.", effects: { usage: +1, budget: -1, reputation: -1, privacy: -1 }, feedback: { usage: "New innovative government use case generates positive buzz! Usage up.", budget: "Initial setup and integration for token issuance is costly. Budget down.", reputation: "Public fears government overreach and surveillance. Reputation down.", privacy: "Government token issuance requires additional data collection and monitoring. Privacy down."}},
                    { text: "Too risky. Digital tokens for official docs are unproven and could be a distraction.", effects: { privacy: +1 }, feedback: { privacy: "Avoiding government token integration protects user privacy. Privacy up."}}
                ]
            },
             // Card 15 - UPDATED
            {
                id: 15,
                situation: "You're testifying before Parliament. A key representative asks: 'Can you explain blockchain to me like I'm five?' You realize they might actually be asking literally.",
                options: [
                    { text: "Attempt a Socratic dialogue about digital piggy banks and shared colouring books.", effects: { reputation: +1 }, feedback: { reputation: "Clear communication earns positive media coverage. Reputation up."}},
                    { text: "Launch into a detailed, technically accurate explanation of cryptographic hashes and Merkle trees.", effects: { usage: -1, reputation: -1 }, feedback: { usage: "Public confidence wanes as nobody understands what you are talking about. Usage down.", reputation: "Confusing technical jargon damages public confidence. Reputation down."}}
                ]
            },
            // Card 16 - UPDATED
            {
                id: 16,
                situation: "An obscure international standards body proposes a 700-page CBDC interoperability protocol written entirely in Esperanto, claiming it's 'neutral ground'. Implementing it would be expensive due to the complexity and specialized work required, while skipping it could avoid those costs entirely.",
                options: [
                    { text: "Publicly praise their 'bold vision' while quietly shelving the document.", effects: { reputation: +1 }, feedback: { reputation: "Diplomatic response maintains international relations. Reputation up."}},
                    { text: "Politely suggest a pilot program with a more... mainstream language.", effects: { resilience: +1, budget: -1 }, feedback: { resilience: "The technical standard actually contains excellent security practices we can adopt. Resilience up.", budget: "Implementing the complex protocol requires significant development resources. Budget down."}}
                ]
            },
            // Card 17 - UPDATED
            {
                id: 17,
                situation: "At a global central bank conference, everyone's bragging about their CBDC pilot's 'innovative AI-driven features'. Yours just... works reliably for payments.",
                options: [
                    { text: "Announce a new 'Quantum-Resistant AI-Powered Synergistic Ledger Optimization Initiative'.", effects: { resilience: -1, budget: -2, reputation: +1 }, feedback: { resilience: "Chasing buzzwords creates operational inefficiencies. Resilience down.", budget: "Now you actually have to *try* and build it, or at least form a committee. Costs skyrocket.", reputation: "The media loves the buzzwords! Reputation up."}},
                    { text: "Emphasize stability, security, and core payment efficiency: 'We're focused on getting the fundamentals right.'", effects: { resilience: +2 }, feedback: { resilience: "Seen as a trustworthy, stable system that delivers on its promises. Resilience way up."}}
                ]
            },
            // Card 18
            {
                id: 18,
                situation: "Citizens are using the CBDC's micropayment feature for everything, from tipping street performers to buying single gumballs. It's highlighting transaction efficiency but also system load.",
                options: [
                    { text: "Issue guidelines: 'CBDC is for substantial commerce, not trivialities!' to manage load.", effects: { usage: -1, resilience: +1 }, feedback: { usage: "Public grumbles about 'nanny state money', some casual use drops.", resilience: "Reduced transaction volume eases system load. Resilience up."}},
                    { text: "Celebrate it! 'The People's Penny!' campaign. Scale up for micro-transactions.", effects: { usage: +1, resilience: -1 }, feedback: { usage: "Micropayments are a massive hit! Usage soars.", resilience: "Increased load is testing system limits. Resilience down."}}
                ]
            },
            // Card 19 - UPDATED
            {
                id: 19,
                situation: "A leaked internal document discusses a 'great reset' protocol. It's our standard disaster recovery plan, but media is spinning it as a way to 'delete citizen's money' at will.",
                options: [
                    { text: "Host an emergency technical briefing to showcase our robust business continuity planning and disaster recovery protocols.", effects: { resilience: +1 }, feedback: { resilience: "Your system resilience makes a strong impression. Resilience up."}},
                    { text: "Decline to comment.", effects: { reputation: -1 }, feedback: { reputation: "Refusing to address concerns about the 'great reset' protocol damages public trust. Reputation down."}}
                ]
            },
            // Card 20
            {
                id: 20,
                situation: "Gen Z wants integrations, Millennials want simplicity, Gen X wants reliability, and Boomers want big buttons. What's your approach?",
                options: [
                    { text: "Launch 'CBDC Your Way': modular design, UX overhaul, core hardening, and an 'Easy Mode'.", effects: { budget: -1, usage: +1, resilience: -1, reputation: +1 }, feedback: { budget: "Catering to everyone's whims with custom features is proving very expensive. Budget down.", usage: "Targeted features are slowly increasing adoption across diverse segments. Usage up.", resilience: "Juggling all these features and integrations is straining the system's operational stability. Resilience down.", reputation: "Inclusive design approach earns public praise. Reputation up."}},
                    { text: "Focus on core resilience and a simple, universal interface. 'CBDC: It Just Works. For Everyone.'", effects: { resilience: +1, usage: -1, budget: +1 }, feedback: { resilience: "The system is a benchmark for stability and trust, appealing to Gen X. Resilience up.", usage: "While reliable, some demographics (Gen Z, Boomers) find it unexciting or not tailored enough, slightly impacting growth. Usage down.", budget: "A focused approach has streamlined development and operational costs. Budget up."}}
                ]
            },
            // Card 21
            {
                id: 21,
                situation: "A minor but persistent bug is causing a 0.5-second transaction delay during peak hours. It's not critical, but tech blogs are starting to notice.",
                options: [
                    { text: "Announce and perform an emergency weekend maintenance to deploy a fix.", effects: { budget: -1, resilience: +2 }, feedback: { budget: "Emergency patches require overtime and rush fees. Budget down.", resilience: "Proactively fixing a performance issue strengthens system resilience. Resilience up."}},
                    { text: "Bundle the fix into the next scheduled quarterly update to save costs and avoid special downtime.", effects: { budget: +1, resilience: -1 }, feedback: { budget: "Avoiding a special deployment saves money. Budget up.", resilience: "Allowing a known performance bug to persist, even a minor one, erodes system resilience over time. Resilience down."}}
                ]
            },
            // Card 21.5 - Secondary Site for Business Continuity
            {
                id: 21.5,
                situation: "Your risk management team is insisting on building a secondary CBDC processing site for 'business continuity.' They want a full replica of your entire system in a different city, just in case something catastrophic happens to the primary site. The budget request is... substantial.",
                options: [
                    { text: "Build the secondary site. You can never be too prepared for disasters!", effects: { budget: -1, resilience: +1 }, feedback: { budget: "Secondary site construction costs are astronomical. Budget down.", resilience: "Now you're prepared for anything short of a zombie apocalypse. Resilience up."}, chosenKey: 'recovery'},
                    { text: "Decline - our current disaster recovery plan is adequate for realistic scenarios.", effects: { budget: +1, resilience: -1 }, feedback: { budget: "Saved a fortune on unnecessary infrastructure. Budget up.", resilience: "Lack of secondary processing site creates vulnerability to catastrophic failures. Resilience down."}}
                ]
            },
            // Card 22 - UPDATED
            {
                id: 22,
                situation: "Your CBDC network is experiencing a massive DDoS attack, causing intermittent service disruptions. The attackers are demanding ransom in cryptocurrency.",
                options: [
                    { 
                        text: "Pay the ransom to restore service quickly and protect users.", 
                        effects: { resilience: +1, security: -1, budget: -1 }, 
                        feedback: { 
                            resilience: "System is restored quickly. Resilience up.", 
                            security: "Paying ransom encourages more attacks. Security down.", 
                            budget: "Ransom payment is expensive. Budget down."
                        }
                    },
                    { 
                        text: "Activate emergency DDoS protection and maintain service through backup systems.", 
                        effects: { resilience: +1 }, 
                        feedback: { resilience: "Your secondary site takes over seamlessly. Resilience up." },
                        conditionalEffects: [
                            {
                                condition: { notChosenKey: 'recovery' },
                                effects: { resilience: -1 },
                                feedback: { resilience: "No backup site available. System struggles under attack. Resilience down." }
                            }
                        ]
                    }
                ]
            },
            // Card 23 - UPDATED
            {
                id: 23,
                situation: "Security researchers have discovered a sophisticated cyber attack targeting CBDC wallets. The attackers are using a novel method to intercept transaction signatures.",
                prerequisite: { cardId: 13 }, // Only appears if Card 13 has appeared
                options: [
                    { 
                        text: "Immediately freeze all transactions and force users to reset their security credentials.", 
                        effects: { resilience: -1, security: +2 }, 
                        feedback: { resilience: "Unplanned maintenance and system freeze weakens operational resilience. Resilience down.", security: "Successfully prevents the attack from spreading. Security way up." }
                    },
                    { 
                        text: "Deploy a silent security patch and monitor for suspicious activity.", 
                        effects: { security: -1 }, 
                        feedback: { security: "A few attacks slip through before the patch is fully effective. Security down." }
                    }
                ]
            },
            // Card 24
            {
                id: 24,
                situation: "Your CBDC prototype AI user help has started giving financial advice in haiku form. Users are confused but oddly entertained. The media is calling it 'the most poetic central bank in history'.",
                options: [
                    { text: "Keep the haiku feature - users love it!", effects: { reputation: +1 }, feedback: { reputation: "Media coverage is positive and entertaining. Reputation up." }},
                    { text: "Reset the AI to standard, boring responses only.", effects: { reputation: -1 }, feedback: { reputation: "Removing the fun feature disappoints users. Reputation down." } }
                ]
            },
            // Card 24.5 - Follow-up to Card 24 (Haiku AI follow-up)
            {
                id: 24.5,
                prerequisite: { cardId: 24, optionIndex: 0 }, // Only if player chose "Keep the haiku" in Card 24
                situation: "The haiku AI has become a cultural phenomenon! Other central banks are asking about your 'poetry protocol,' and a major tech company wants to license the haiku feature for their financial app.",
                options: [
                    { text: "Share the technology openly with other central banks.", effects: { reputation: +1 }, feedback: { reputation: "Open collaboration earns international respect. Reputation up."}},
                    { text: "License it to other central banks for a substantial fee.", effects: { budget: +1, reputation: -1 }, feedback: { budget: "Licensing deal generates significant revenue. Budget up.", reputation: "Selling this technology to other central banks is poorly perceived in the central banking community. Reputation down."}}
                ]
            },
            // Card 25 - NEW (update prerequisite to require chosenKey 'offline_invest')
            {
                id: 25,
                situation: "The International Space Station wants to install a vending machine for astronauts. They need a payment system that works offline during periods of limited Earth connectivity. This could be the perfect opportunity to showcase CBDC's offline capabilities.",
                prerequisite: { chosenKey: 'offline_invest' }, // Only appears if offline CBDC was implemented
                options: [
                    { 
                        text: "Develop a special offline CBDC system for the ISS vending machine.", 
                        effects: { usage: +1, resilience: +2, budget: -1, reputation: +2 }, 
                        feedback: { usage: "Astronauts buying chocolate bars with CBDC makes great publicity! Usage up.", resilience: "Successfully testing offline capabilities in space proves system reliability. Resilience way up.", budget: "Testing space-ready systems is expensive. Budget down.", reputation: "Space deployment generates massive positive publicity! Reputation way up." }
                    },
                    { 
                        text: "Focus on perfecting offline capabilities on Earth first.", 
                        effects: { reputation: -1 }, 
                        feedback: { reputation: "Public sees CBDC as less innovative without space testing. Reputation down." }
                    }
                ]
            },
            // New Card: CBDC for Disaster Relief (Helicopter Money)
            {
                id: 26,
                prerequisite: { chosenKey: 'programmable_money' },
                situation: "A major natural disaster has struck. Aid groups want to send aid. With programmable money you could send 'helicopter money' directly to those in need.",
                options: [
                    {
                        text: "Fast-track the transfer of helicopter money to wallets for immediate aid and adoption.",
                        effects: { usage: +1, resilience: +1, budget: -2, reputation: +1 },
                        feedback: {
                            usage: "Rapid emergency payments boost CBDC adoption and goodwill.",
                            resilience: "CBDC is seen as a reliable tool for crisis response.",
                            budget: "Coordinating and distributing large-scale transfers is costly.",
                            reputation: "Humanitarian aid generates positive publicity. Reputation up."
                        }
                    },
                    {
                        text: "Refrain. This isn't the central bank's role.",
                        effects: { reputation: -1, budget: +2 },
                        feedback: {
                            reputation: "Refusing emergency aid damages public perception. Reputation down.",
                            budget: "Budget preserved by not funding emergency aid."
                        }
                    }
                ]
            },
            // New Card: Satirical Fraud/Dispute Management
            {
                id: 27,
                situation: "A user buys a 'limited edition smart fridge' for an astronomical price from a suspicious online store. Shockingly, nothing is delivered. The user is furious and demands the CBDC manager fix it.",
                options: [
                    {
                        text: "Implement a dispute management mechanism for CBDC transactions.",
                        effects: { budget: -1, security: +1 },
                        feedback: {
                            budget: "Building and running a dispute system is expensive! Budget down.",
                            security: "Fraudsters are less likely to get away with scams. Security up.",
                            usage: "No direct impact on usage from this decision.",
                            privacy: "No direct impact on privacy from this decision.",
                            reputation: "No direct impact on reputation from this decision."
                        },
                        chosenKey: 'dispute'
                    },
                    {
                        text: "Remind everyone that 'no digital cash' means 'not our problem'. Buyer beware!",
                        effects: { usage: -1, security: -1, privacy: +1, reputation: -1 },
                        feedback: {
                            usage: "Users are upset by the lack of recourse. Usage down.",
                            security: "Scammers rejoice at the lack of oversight. Security down.",
                            privacy: "No dispute system means less data collection, privacy up.",
                            reputation: "Lack of consumer protection damages public trust. Reputation down."
                        }
                    }
                ]
            },
            // Card 27.5 - Dispute System Overload (Follow-up to Card 27 Option 1)
            {
                id: 27.5,
                prerequisite: { cardId: 27, optionIndex: 0 }, // Only if player chose to implement dispute management
                situation: "The dispute management system is overwhelmed with frivolous claims. Merchants are demanding stricter eligibility criteria, while consumer groups want more protection. The system costs are spiraling out of control.",
                options: [
                    { text: "Tighten eligibility criteria to reduce frivolous claims.", effects: { security: +1 }, feedback: { security: "Stricter criteria reduce fraudulent claims and improve system security. Security up."}},
                    { text: "Hire more staff and expand the system.", effects: { budget: -1, security: +2 }, feedback: { budget: "Additional staffing and system expansion is costly. Budget down.", security: "Expanded system provides better fraud detection and protection. Security up."}}
                ]
            },
            // Card 28 - Offline Feature Conditional
            {
                id: 28,
                prerequisite: { chosenKey: 'offline_invest' },
                situation: "After launching offline CBDC, a remote mountain village holds a festival where all payments are made using your system. However, a local prankster claims to have spent the same money at two different stalls while offline.",
                options: [
                    {
                        text: "Launch an investigation and patch the offline protocol, even if it means temporary downtime for remote users.",
                        effects: { budget: -1, resilience: +1, reputation: +1 },
                        feedback: {
                            budget: "Emergency patching is costly. Budget down.",
                            resilience: "Patch improves system trust. Resilience up.",
                            reputation: "Proactive response to security concerns earns trust. Reputation up."
                        }
                    },
                    {
                        text: "Downplay the incident as a one-off and promise future improvements.",
                        effects: { security: -1, usage: -1, reputation: -1 },
                        feedback: {
                            security: "Prank inspires copycats. Security down.",
                            usage: "Fear of double-spending hurts adoption. Usage down.",
                            reputation: "Downplaying security concerns damages trust. Reputation down."
                        }
                    }
                ]
            },
            // Card 29 - Post-Quantum Feature Conditional
            {
                id: 29,
                prerequisite: { chosenKey: 'crypto_postquantum' },
                situation: "Your cryptography expert comes to you and recommends implementing Homomorphic Encryption for enhanced security. They explain it's significantly safer but will make transactions a bit slower.",
                options: [
                    {
                        text: "Accept the recommendation. Security is paramount.",
                        effects: { security: +1, usage: -1 },
                        feedback: {
                            security: "Homomorphic Encryption provides enhanced security. Security up.",
                            usage: "Slower transactions frustrate some users. Usage down."
                        }
                    },
                    {
                        text: "Decline. Speed is more important for user adoption.",
                        effects: { usage: +1, security: -1 },
                        feedback: {
                            usage: "Faster transactions boost adoption. Usage up.",
                            security: "Slightly reduced security is a trade-off. Security down."
                        }
                    }
                ]
            },
            // Card 30 - Interoperability Feature Conditional
            {
                id: 30,
                prerequisite: { chosenKey: 'interoperability' },
                situation: "Thanks to your interoperability protocol, a popular ride-sharing app wants to integrate CBDC payments. However, their system is known for frequent outages.",
                options: [
                    {
                        text: "Approve the integration, but require strict uptime guarantees.",
                        effects: { resilience: +1, reputation: +1 },
                        feedback: {
                            resilience: "Uptime guarantees protect your system. Resilience up.",
                            reputation: "Professional approach to partnerships earns respect. Reputation up."
                        }
                    },
                    {
                        text: "Allow integration with no extra requirements to boost adoption quickly.",
                        effects: { usage: +1, resilience: -1, reputation: -1 },
                        feedback: {
                            usage: "CBDC use in ride-sharing surges. Usage up.",
                            resilience: "Frequent outages hurt your system's reputation. Resilience down.",
                            reputation: "Frequent outages hurt your system's reputation. Reputation down."
                        }
                    }
                ]
            },
            // Card 31 - Dispute Feature Conditional
            {
                id: 31,
                prerequisite: { chosenKey: 'dispute' },
                situation: "With your new dispute management system, users are filing complaints about everything from late pizza deliveries to broken headphones. The system is overwhelmed.",
                options: [
                    {
                        text: "Tighten dispute eligibility to only cover clear cases of fraud.",
                        effects: { security: -1, reputation: -1 },
                        feedback: {
                            security: "Fewer frivolous claims. Security down.",
                            reputation: "Reduced consumer protection damages public trust. Reputation down."
                        }
                    },
                    {
                        text: "Hire more staff and automate the process to handle all complaints.",
                        effects: { budget: -1, usage: +1, reputation: +1 },
                        feedback: {
                            budget: "Staffing and automation are expensive. Budget down.",
                            usage: "Users love the responsive service. Usage up.",
                            reputation: "Responsive customer service earns public trust. Reputation up."
                        }
                    }
                ]
            },
            // New Card: Incumbent Payment Scheme Complaints
            {
                id: 40,
                situation: "Incumbent payment schemes complain that your low CBDC fees are unfair competition, claiming it's hurting their business.",
                options: [
                    { text: "Increase CBDC fees to appease incumbents.", effects: { usage: -1, budget: +1, reputation: -1 }, feedback: { usage: "Higher fees slow down CBDC adoption. Usage down.", budget: "Increased fees improve your budget.", reputation: "Giving in to incumbent pressure damages public trust. Reputation down."}},
                    { text: "Refuse to change your fees and keep them low.", effects: { usage: +1, reputation: +1 }, feedback: { usage: "Low fees attract more users to CBDC. Usage up.", reputation: "Standing up for consumer interests earns public respect. Reputation up."}}
                ]
            },
            // Card 41 - UPDATED (Conditional on fraud scoring tool)
            {
                id: 41,
                prerequisite: { chosenKey: 'fraud_scoring_tool' },
                situation: "A new scam trend emerges: 'CBDC Doubler' users on social networks promise to double digital cash if it's sent to a scammer address. Social media is flooded with testimonials from 'satisfied' cartoon avatars. Regulators want action‚Äîwhat's your next move?",
                options: [
                    {
                        text: "Add a prominent disclaimer: 'If someone promises to double your CBDC, they're probably doubling their own.'",
                        effects: { security: -1 },
                        feedback: { security: "Disclaimer ignored, scams continue. Security down." }
                    },
                    {
                        text: "Update the fraud monitoring tool to also capture this type of fraud.",
                        effects: { security: +1 },
                        feedback: { security: "Scams detected and blocked. Security up." }
                    }
                ]
            },
            // Card 42 - Settlement Finality (NEW)
            {
                id: 42,
                situation: "A small and unknown activist group publishes a blog post claiming that CBDC transactions are irreversible, warning that 'one typo can ruin your life.' They demand a 'regret button' for all payments. How do you respond?",
                options: [
                    {
                        text: "Introduce a 'regret button'‚Äîusers can reverse transactions for 30 seconds after sending.",
                        effects: { security: -1, resilience: -1 },
                        feedback: { security: "Fraud risk up. Security down.", resilience: "Settlement finality weakened. Resilience down." }
                    },
                    {
                        text: "Politely decline.",
                        effects: {},
                        feedback: {}
                    }
                ]
            },
            // Card 43 - Building the Fraud Scoring Tool (Feature Unlock)
            {
                id: 43,
                prerequisite: { notChosenKey: 'fraud_scoring_tool' },
                situation: "Your team proposes developing a sophisticated fraud scoring tool to proactively detect suspicious CBDC transactions. Some argue it's unnecessary‚Äîafter all, 'cash never had a fraud scoring tool.' Do you build it?",
                options: [
                    {
                        text: "No need‚Äîcash never had a fraud scoring tool. Let's keep it simple.",
                        effects: { budget: +1, security: -2, privacy: +1 },
                        feedback: {
                            budget: "Saves money by avoiding new development. Budget up.",
                            security: "Fraud risk rises without proactive detection. Security down.",
                            privacy: "Less data collected means more privacy. Privacy up."
                        }
                    },
                    {
                        text: "Yes, safety first‚Äîlet's build the fraud scoring tool.",
                        effects: { budget: -2, security: +2, privacy: -1 },
                        feedback: {
                            budget: "Development is expensive. Budget down.",
                            security: "Fraud risk down with proactive detection. Security up.",
                            privacy: "The tool requires transaction data. Privacy down."
                        },
                        chosenKey: 'fraud_scoring_tool'
                    }
                ]
            },
            // Card 44 - Enhancing the Fraud Scoring Tool (Conditional on Feature)
            {
                id: 44,
                prerequisite: { chosenKey: 'fraud_scoring_tool' },
                situation: "Your engineers suggest the fraud scoring tool could be even more effective if it's allowed to analyze users' personal information. Privacy advocates are already sharpening their pitchforks. Do you approve the upgrade?",
                options: [
                    {
                        text: "Approve the upgrade‚Äîsecurity is paramount, even if it means less privacy.",
                        effects: { security: +2, privacy: -2 },
                        feedback: {
                            security: "Tool is more effective. Security up.",
                            privacy: "Privacy concerns rise. Privacy down."
                        }
                    },
                    {
                        text: "Decline‚Äîrespect user privacy, even if it means a less effective tool.",
                        effects: { security: -1, privacy: +2 },
                        feedback: {
                            security: "Tool is less effective. Security down.",
                            privacy: "Privacy protected. Privacy up."
                        }
                    }
                ]
            },
            // Card 45 - Privacy Audit Transparency
            {
                id: 45,
                situation: "Your auditors have conducted a comprehensive privacy audit of the CBDC system. Citizens are demanding transparency, but sharing the full report could reassure them while also highlighting some confidential security information.",
                options: [
                    {
                        text: "Share the privacy audit report publicly to demonstrate transparency.",
                        effects: { privacy: +1, security: -1 },
                        feedback: {
                            privacy: "Public transparency builds trust in privacy protections. Privacy up.",
                            security: "Revealing security details in the report creates vulnerabilities. Security down."
                        }
                    },
                    {
                        text: "Keep the report confidential to protect security information.",
                        effects: { privacy: -1, security: +1 },
                        feedback: {
                            privacy: "Lack of transparency raises privacy concerns. Privacy down.",
                            security: "Keeping security details confidential protects the system. Security up."
                        }
                    }
                ]
            },
            // --- NEW CONDITIONAL CARDS FOR EACH FEATURE ---
            {
                id: 50,
                prerequisite: { chosenKey: 'offline_invest' },
                situation: "During a city-wide blackout, a local bakery becomes the hero of the neighborhood by accepting offline CBDC for emergency bread sales. The next morning, the bakery owner is shocked to discover their wallet is bursting with digital cash‚Äîfar more than the bread they actually sold. The media dubs it 'The Great Offline Bread Boom.'",
                options: [
                    { text: "Quietly adjust the bakery's balance and issue a technical statement about 'enthusiastic offline settlement.'", effects: { reputation: -2, security: +1 }, feedback: { reputation: "You killed a nice story. Reputation down.", security: "Technical issue resolved, preventing future abuse. Security up." }},
                    { text: "Declare the event a 'pilot success' and encourage more entrepreneurial spirit.", effects: { usage: +1, security: -1 }, feedback: { usage: "Entrepreneurs everywhere are inspired to try their luck. Usage up.", security: "People try to abuse the bug. Security down." }}
                ]
            },
            {
                id: 51,
                prerequisite: { chosenKey: 'crypto_postquantum' },
                situation: "A quantum computing startup claims their new device can break every cryptosystem except your CBDC's. They challenge you to a public 'hack-off' streamed live, with the winner getting a lifetime supply of quantum-safe socks.",
                options: [
                    { text: "Accept the challenge and livestream the event with running commentary from celebrity mathematicians.", effects: { security: +1, reputation: +1 }, feedback: { security: "Your system survives the quantum onslaught. Security up.", reputation: "The public loves the spectacle. Reputation up." }},
                    { text: "Politely decline, citing 'seriousness of central banking' and send them a pair of socks anyway.", effects: { reputation: -1 }, feedback: { reputation: "The internet mocks your lack of quantum sportsmanship. Reputation down." }}
                ]
            },
            {
                id: 52,
                prerequisite: { chosenKey: 'interoperability' },
                situation: "Your CBDC is now interoperable with a foreign jurisdiction's digital currency. The first cross-border transaction is a payment for a rare, collectible hamster. Customs officials are baffled, and the press dubs it 'Hamstergate.'",
                options: [
                    { text: "Celebrate the seamless hamster import as a triumph of global finance.", effects: { usage: +1, resilience: +1 }, feedback: { usage: "Cross-border payments surge. Usage up.", resilience: "System proves robust under international scrutiny. Resilience up." }},
                    { text: "Issue a stern warning about 'responsible use of cross-border CBDC' and propose a hamster import quota.", effects: { reputation: -1 }, feedback: { reputation: "Hamster enthusiasts and free trade advocates protest. Reputation down." }}
                ]
            },
            {
                id: 53,
                prerequisite: { chosenKey: 'dispute' },
                situation: "Your dispute management system is so efficient that users start filing complaints about the weather, their neighbor's dog, and existential dread. The system is now the nation's top source of catharsis.",
                options: [
                    { text: "Add an automated response: 'CBDC cannot resolve the weather, but we hope your day improves!'", effects: {}, feedback: {}},
                    { text: "Limit dispute submissions to actual financial transactions, with a pop-up quiz on what money is.", effects: { resilience: +1 }, feedback: { resilience: "Fewer useless transactions improve system efficiency. Resilience up." }}
                ]
            },
            {
                id: 54,
                prerequisite: { chosenKey: 'programmable_money' },
                situation: "The government is ready to put big budget for you to implement 'Donut Credits'‚Äîcitizens can only buy donuts on Fridays. The public decries 'Big Donut' overreach.",
                options: [
                    { text: "Allow the donut credits program.", effects: { privacy: -1, reputation: -1, budget: +1 }, feedback: { privacy: "Government control over food purchases reduces privacy. Privacy down.", reputation: "Public sees this as government overreach. Reputation down.", budget: "Government funding boosts your budget. Budget up."}},
                    { text: "Refuse.", effects: { privacy: +1 }, feedback: { privacy: "Maintaining financial freedom protects user privacy. Privacy up."}}
                ]
            },
            {
                id: 55,
                prerequisite: { chosenKey: 'recovery' },
                situation: "A surprise fire drill at your recovery site turns into a viral dance challenge when staff evacuate in perfect formation. The video is trending as #CBDCSafetyShuffle, but auditors are asking why so many resources are spent on choreography.",
                options: [
                    { text: "Invite the auditors to join the next drill and publish a 'CBDC Safety Dance' best practices guide.", effects: { resilience: +1 }, feedback: { resilience: "Staff morale and system resilience both up. Resilience up." }},
                    { text: "Ban all dancing and require staff to walk briskly in single file during drills.", effects: { resilience: -1 }, feedback: { resilience: "Morale plummets, and so does drill performance. Resilience down." }}
                ]
            },
            // --- NEW SATIRICAL CARDS ---
            {
                id: 60,
                situation: "To enhance security, a colleague suggests requiring users to solve a complex riddle from a grumpy sphinx before each transaction. It's foolproof, but will slow down checkout lines.",
                options: [
                    {
                        text: "Launch \"the sphinx\". security is worth the inconvenience.",
                        effects: { security: +1, usage: -1 },
                        feedback: {
                            security: "The sphinx is a great guard, but annoying. Security up.",
                            usage: "Users are not happy with the riddles. Usage down."
                        }
                    },
                    {
                        text: "Let's stick to passwords .",
                        effects: { },
                        feedback: { }
                    }
                ]
            },
            {
                id: 62,
                situation: "To prove the CBDC's resilience, your engineers suggest testing if the data center can survive a direct lightning strike by building a giant lightning rod on top of it.",
                options: [
                    {
                        text: "Build the lightning rod! We shall challenge the gods of the sky!",
                        effects: { resilience: +2, budget: -1 },
                        feedback: {
                            resilience: "The system is now Zeus-proof. Resilience way up.",
                            budget: "Challenging gods is not cheap. Budget down."
                        }
                    },
                    {
                        text: "Maybe let's just build a standard business continuity plan?",
                        effects: { resilience: +1 },
                        feedback: {
                            resilience: "A standard business continuity plan improves system resilience. Resilience up."
                        }
                    }
                ]
            },
            // Card 65 - The Birthday Gift (Privacy)
            {
                id: 65,
                situation: "To celebrate the CBDC's first anniversary, the marketing team suggests airdropping a small amount of CBDC to every citizen on their birthday. It's a great PR move, but requires linking wallets to official birthday records.",
                options: [
                    {
                        text: "A great PR move! People will love getting a birthday gift from the central bank.",
                        effects: { privacy: -1, budget: -1, reputation: +1 },
                        feedback: {
                            privacy: "Linking wallets to birthdays compromises user privacy. Privacy down.",
                            budget: "Airdropping CBDC to everyone is expensive. Budget down.",
                            reputation: "People love free money! Reputation up."
                        }
                    },
                    {
                        text: "Absolutely not. We cannot link wallets to personal identity data like birthdays.",
                        effects: { privacy: +1 },
                        feedback: {
                            privacy: "Maintaining wallet anonymity protects user privacy. Privacy up."
                        }
                    }
                ]
            },
            // Card 66 - The Chaos Monkey (Resilience)
            {
                id: 66,
                situation: "Your engineers want to implement a 'Chaos Monkey' strategy - randomly shutting down parts of the CBDC system to test resilience. They argue that if the system can't handle random failures, it's not robust enough.",
                options: [
                    {
                        text: "Deploy the Chaos Monkey in the live environment during peak hours. We need to know our system can handle anything.",
                        effects: { resilience: +2, usage: -1 },
                        feedback: {
                            resilience: "The system proves incredibly robust under random failures. Resilience way up.",
                            usage: "Users are frustrated by unexpected outages during peak hours. Usage down."
                        },
                        achievement: 'chaosMonkey'
                    },
                    {
                        text: "Do it in the test environment.",
                        effects: { resilience: +1 },
                        feedback: {
                            resilience: "Testing in the test environment improves system resilience without disrupting users. Resilience up."
                        }
                    }
                ]
            },
            // Card 67 - The NFT Commission (Cost)
            {
                id: 67,
                situation: "A government official suggests commissioning CBDC-themed NFTs to appear 'modern.' The budget exceeds your cybersecurity team's annual funding. The proposed artwork is... questionable.",
                options: [
                    {
                        text: "Approve the commission. Art elevates our brand!",
                        effects: { budget: -1, reputation: -1 },
                        feedback: {
                            budget: "NFTs are expensive. Budget down.",
                            reputation: "NFTs? We're back to 2021. Reputation down."
                        }
                    },
                    {
                        text: "Reject the proposal. We are a central bank, not an art gallery.",
                        effects: { budget: +1 },
                        feedback: {
                            budget: "Avoiding unnecessary expenses saves money. Budget up."
                        }
                    }
                ]
            },
            // Card 68 - The Quantum Safe (Security)
            {
                id: 68,
                situation: "A cryptographer offers a 'quantum-entangled safe' for the CBDC master key. They claim the key exists in a superposition state - both secure and vulnerable until observed. The service costs a fortune.",
                options: [
                    {
                        text: "Pay for the quantum safe. We must have the most advanced security!",
                        effects: { budget: -1, security: +1 },
                        feedback: {
                            budget: "Quantum services are incredibly expensive. Budget down.",
                            security: "The quantum safe provides advanced security protection. Security up."
                        },
                        conditionalEffects: [
                            {
                                condition: { chosenKey: 'crypto_postquantum' },
                                effects: { security: +1 },
                                feedback: { security: "Combined with post-quantum cryptography, security is now impenetrable!" }
                            }
                        ]
                    },
                    {
                        text: "Our current cold storage is both secure and cost-effective.",
                        effects: {},
                        feedback: {}
                    }
                ]
            },
            // Card 69 - The Social Media Integration (Privacy)
            {
                id: 69,
                situation: "A popular social media platform wants to integrate CBDC payments directly into their app. They promise massive adoption, but require access to users' transaction data for 'personalized financial insights.'",
                options: [
                    {
                        text: "Accept the integration. Think of all the new users we'll get!",
                        effects: { usage: +1, privacy: -1 },
                        feedback: {
                            usage: "Social media integration brings new users to CBDC. Usage up.",
                            privacy: "Sharing transaction data with social media compromises user privacy. Privacy down."
                        }
                    },
                    {
                        text: "Decline. We won't compromise user privacy for adoption.",
                        effects: { privacy: +1 },
                        feedback: {
                            privacy: "Protecting user privacy maintains trust in the system. Privacy up."
                        }
                    }
                ]
            },
            // Card 70 - The Penetration Testing Party (Security)
            {
                id: 70,
                situation: "Your security team wants to hire a famous 'ethical hacker' who streams their penetration testing on Twitch. They claim it will be great publicity and prove the system's security, but it's essentially live-streaming potential attacks on your CBDC.",
                options: [
                    {
                        text: "Let's make it a show! Nothing builds confidence like watching someone fail to hack us live.",
                        effects: { security: +1, reputation: +1 },
                        feedback: {
                            security: "The hacker failed to breach our system! Security up.",
                            reputation: "Public demonstration of security builds trust. Reputation up."
                        },
                        conditionalEffects: [
                            {
                                condition: { notChosenKey: 'crypto_postquantum' },
                                effects: { security: -1, reputation: -1 },
                                feedback: { 
                                    security: "The hacker succeeded and everyone saw it live! Security down.",
                                    reputation: "Public failure damages trust in the system. Reputation down."
                                }
                            }
                        ]
                    },
                    {
                        text: "Security testing should be private and professional, not entertainment.",
                        effects: {},
                        feedback: {}
                    }
                ]
            },
            // Card 71 - The Backup Backup Backup (Resilience)
            {
                id: 71,
                prerequisite: { chosenKey: 'recovery' },
                situation: "Your disaster recovery team insists on building a third backup data center 'just in case.' They want it in a converted missile silo deep underground, claiming it's 'nuclear-proof.' The cost is astronomical.",
                options: [
                    {
                        text: "Build the nuclear-proof backup. You can never be too prepared!",
                        effects: { resilience: +2, budget: -2 },
                        feedback: {
                            resilience: "Nuclear-proof backup makes the system virtually indestructible. Resilience way up.",
                            budget: "Converting missile silos is incredibly expensive. Budget way down."
                        },
                        achievement: 'nuclearProof'
                    },
                    {
                        text: "One backup center is already good enough.",
                        effects: { budget: +1 },
                        feedback: {
                            budget: "Avoiding unnecessary third backup saves money. Budget up."
                        }
                    }
                ]
            },
            // Card 72 - The Microtransaction Revolution (Usage vs. Resilience)
            {
                id: 72,
                situation: "Users are demanding to wave subcent transactions for everything - paying 0.001 CBDC to unlock a phone app feature, 0.005 CBDC to skip an ad, etc. Processing these tiny transactions costs more than they're worth.",
                options: [
                    {
                        text: "Embrace the microtransaction economy! Every cent counts.",
                        effects: { usage: +1 },
                        feedback: {
                            usage: "Microtransactions become popular, increasing overall usage. Usage up."
                        }
                    },
                    {
                        text: "Keep minimum transaction amount. We don't want to get overloaded.",
                        effects: { resilience: +1 },
                        feedback: {
                            resilience: "Avoiding microtransaction overload keeps the system stable. Resilience up."
                        }
                    }
                ]
            },
            // Card 73 - The Efficiency Drive (Budget vs. Usage)
            {
                id: 73,
                situation: "Your operations team proposes cutting CBDC payments during the middle of the night. They claim it will save money on processing costs, but a few users rely on late-night transactions.",
                options: [
                    {
                        text: "Cut night payments.",
                        effects: { budget: +1, usage: -1 },
                        feedback: {
                            budget: "Cutting night operations saves processing costs. Budget up.",
                            usage: "Some users are frustrated by the reduced availability. Usage down."
                        }
                    },
                    {
                        text: "Keep 24/7 payments. What kind of central bank shuts down at night?",
                        effects: { usage: +1 },
                        feedback: {
                            usage: "Users appreciate the round-the-clock service. Usage up."
                        }
                    }
                ]
            },
            // Card 74 - The COBOL Retirement (Budget vs. Resilience)
            {
                id: 74,
                situation: "Your IT team wants to retire a mysterious COBOL system that's been running since no one knows when. No one can read the code anymore, and nobody really knows if it's doing anything useful, but it costs money to maintain.",
                options: [
                    {
                        text: "Retire the COBOL system. We can't afford to maintain ancient infrastructure nobody understands.",
                        effects: { budget: +1, resilience: -1 },
                        feedback: {
                            budget: "Eliminating legacy system maintenance costs saves money. Budget up.",
                            resilience: "Removing the mysterious system creates uncertainty about system stability. Resilience down."
                        }
                    },
                    {
                        text: "Keep the COBOL system. If it's been running for all this time, it must be doing something important.",
                        effects: { resilience: +1 },
                        feedback: {
                            resilience: "Keeping the mysterious system maintains the status quo. Resilience up."
                        }
                    }
                ]
            },
            // Card 75 - The Cloud Migration (Budget vs. Privacy)
            {
                id: 75,
                situation: "Your procurement team suggests migrating CBDC processing to a major cloud provider. The savings are real, but despite their promises, you can't guarantee that big tech won't have access to transaction data.",
                options: [
                    {
                        text: "Move to the cloud. We can't justify the infrastructure costs anymore.",
                        effects: { budget: +1, privacy: -1 },
                        feedback: {
                            budget: "Cloud migration reduces infrastructure costs significantly. Budget up.",
                            privacy: "Big tech's potential access to transaction data raises privacy concerns. Privacy down."
                        }
                    },
                    {
                        text: "Keep it internal. We can't trust big tech with our citizens' financial data.",
                        effects: { privacy: +1 },
                        feedback: {
                            privacy: "Maintaining internal control protects user privacy. Privacy up."
                        }
                    }
                ]
            },
            {
                id: 27.8,
                prerequisite: { chosenKey: 'fraud_scoring_tool' },
                situation: "A new scam trend emerges: 'CBDC Doubler' users on social networks promise to double digital cash if it's sent to a scammer address. Social media is flooded with testimonials from 'satisfied' cartoon avatars. Regulators want action‚Äîwhat's your next move?",
                options: [
                    {
                        text: "Add a prominent disclaimer: 'If someone promises to double your CBDC, they're probably doubling their own.'",
                        effects: { reputation: +1 },
                        feedback: { reputation: "Clear, visible warnings help some users avoid the scam. Reputation up." }
                    },
                    {
                        text: "Update the fraud monitoring tool to also capture this type of fraud.",
                        effects: { security: +1, budget: -1 },
                        feedback: { security: "Fraud scoring tool now flags 'CBDC Doubler' scams. Security up.", budget: "Expanding the tool's scope requires extra resources. Budget down." }
                    }
                ]
            }
        ];

        // --- GAME LOGIC FUNCTIONS ---

        // Modified shuffleDeck to support prerequisites and enforce correct placement of conditional cards
        function buildDeckWithPrerequisites(cards) {
            // Separate main, feature-dependent, follow-up, and conditional effect cards
            const mainCards = [];
            const featureCards = [];
            const followupCards = [];
            const conditionalCards = [];
            
            for (const card of cards) {
                // Check if card has conditional effects
                let hasConditionalEffects = false;
                for (const option of card.options) {
                    if (option.conditionalEffects && option.conditionalEffects.length > 0) {
                        hasConditionalEffects = true;
                        break;
                    }
                }
                
                if (hasConditionalEffects) {
                    conditionalCards.push(card);
                } else if (card.prerequisite && card.prerequisite.chosenKey) {
                    featureCards.push(card);
                } else if (card.prerequisite && card.prerequisite.cardId !== undefined && card.prerequisite.optionIndex !== undefined) {
                    followupCards.push(card);
                } else {
                    mainCards.push(card);
                }
            }
            shuffleDeck(mainCards);
            shuffleDeck(conditionalCards);
            
            // Define specific positions for feature cards (6th one at 37 instead of 41)
            const featurePositions = [7, 13, 19, 23, 29, 37];
            shuffleDeck(featurePositions);
            
            // Build deck, inserting follow-ups and feature cards at the right time
            const deck = [];
            const appeared = new Set();
            const chosenKeys = new Set();
            let featureIndex = 0;
            let conditionalIndex = 0;
            let i = 0;
            
            while (i < mainCards.length) {
                const card = mainCards[i];
                deck.push(card);
                appeared.add(card.id);
                // Track chosenKeys as player would unlock them
                for (const opt of card.options) {
                    if (opt.chosenKey) {
                        chosenKeys.add(opt.chosenKey);
                    }
                }
                // Check if this card triggers a follow-up
                for (const fcard of followupCards) {
                    if (fcard.prerequisite.cardId === card.id) {
                        // Insert follow-up immediately after this card
                        deck.push(fcard);
                        appeared.add(fcard.id);
                    }
                }
                // Check if we should insert a feature card at this position
                if (featureIndex < featurePositions.length && deck.length >= featurePositions[featureIndex]) {
                    // Find a feature card that can be placed here and whose prerequisite is met
                    for (const fcard of featureCards) {
                        if (!appeared.has(fcard.id) && fcard.prerequisite && chosenKeys.has(fcard.prerequisite.chosenKey)) {
                            deck.push(fcard);
                            appeared.add(fcard.id);
                            break;
                        }
                    }
                    featureIndex++;
                }
                // Insert conditional cards after the player has had a chance to make relevant choices
                // Wait until at least 5 cards have been seen to ensure player has made some key decisions
                if (deck.length >= 5) {
                    // Only insert conditional cards whose prerequisites are now satisfied
                    while (conditionalIndex < conditionalCards.length) {
                        const ccard = conditionalCards[conditionalIndex];
                        let prereqMet = true;
                        if (ccard.prerequisite && ccard.prerequisite.chosenKey) {
                            prereqMet = chosenKeys.has(ccard.prerequisite.chosenKey);
                        } else if (ccard.prerequisite && ccard.prerequisite.notChosenKey) {
                            prereqMet = !chosenKeys.has(ccard.prerequisite.notChosenKey);
                        }
                        if (prereqMet && !appeared.has(ccard.id)) {
                            deck.push(ccard);
                            appeared.add(ccard.id);
                        }
                        conditionalIndex++;
                        // Only insert one per round to avoid flooding
                        break;
                    }
                }
                i++;
            }
            // Add remaining conditional cards at the end, but only if their prerequisites are satisfied
            while (conditionalIndex < conditionalCards.length) {
                const ccard = conditionalCards[conditionalIndex];
                let prereqMet = true;
                if (ccard.prerequisite && ccard.prerequisite.chosenKey) {
                    prereqMet = chosenKeys.has(ccard.prerequisite.chosenKey);
                } else if (ccard.prerequisite && ccard.prerequisite.notChosenKey) {
                    prereqMet = !chosenKeys.has(ccard.prerequisite.notChosenKey);
                }
                if (prereqMet && !appeared.has(ccard.id)) {
                    deck.push(ccard);
                    appeared.add(ccard.id);
                }
                conditionalIndex++;
            }
            // Add any feature/followup cards not already added (shouldn't happen, but for safety)
            for (const fcard of featureCards.concat(followupCards)) {
                if (!appeared.has(fcard.id)) deck.push(fcard);
            }
            return deck;
        }

        function shuffleDeck(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function getIndicatorLabel(value) {
            return INDICATOR_SCALE_LABELS[Math.max(0, Math.min(value, MAX_INDICATOR_VALUE))];
        }
        
        function getBarColor(value) {
            // value: 0 (low/red) to MAX_INDICATOR_VALUE (high/green)
            const percent = value / MAX_INDICATOR_VALUE;
            
            // Three-color interpolation: red -> blue -> green
            if (percent <= 0.5) {
                // Red to Blue (0% to 50%)
                const localPercent = percent * 2; // 0 to 1
                const r = Math.round(244 + (59 - 244) * localPercent); // 244 -> 59 (red to blue)
                const g = Math.round(67 + (130 - 67) * localPercent);  // 67 -> 130
                const b = Math.round(54 + (246 - 54) * localPercent);  // 54 -> 246
                return `rgb(${r},${g},${b})`;
            } else {
                // Blue to Green (50% to 100%)
                const localPercent = (percent - 0.5) * 2; // 0 to 1
                const r = Math.round(59 + (76 - 59) * localPercent);   // 59 -> 76 (blue to green)
                const g = Math.round(130 + (175 - 130) * localPercent); // 130 -> 175
                const b = Math.round(246 + (80 - 246) * localPercent);  // 246 -> 80
                return `rgb(${r},${g},${b})`;
            }
        }

        function renderIndicators() {
            // Clear existing content from indicator cards
            const indicatorCards = [
                'usage-indicator-card',
                'reputation-indicator-card', 
                'budget-indicator-card',
                'resilience-indicator-card',
                'security-indicator-card',
                'privacy-indicator-card'
            ];
            
            const indicatorOrder = ['usage', 'reputation', 'budget', 'resilience', 'security', 'privacy'];
            
            indicatorOrder.forEach((key, index) => {
                const cardElement = document.getElementById(indicatorCards[index]);
                if (cardElement && indicators[key]) {
                    const indicatorData = indicators[key];
                    
                    cardElement.innerHTML = `
                        <h3 class="text-md font-semibold text-gray-700 mb-1 text-center">${indicatorData.name}</h3>
                        <div class="indicator-bar-bg w-full mb-1">
                            <div id="${key}-bar" class="indicator-bar"></div>
                        </div>
                        <p id="${key}-label" class="indicator-level-text text-sm text-gray-600 text-center"></p>
                        <p id="${key}-feedback" class="feedback-text text-gray-500 text-center">${indicatorData.feedback || ""}</p>
                    `;

                    const barElement = document.getElementById(`${key}-bar`);
                    const labelElement = document.getElementById(`${key}-label`);
                    const feedbackElement = document.getElementById(`${key}-feedback`);

                    const percentage = (indicatorData.value / MAX_INDICATOR_VALUE) * 100;
                    barElement.style.width = `${percentage}%`;
                    barElement.style.backgroundColor = getBarColor(indicatorData.value);
                    labelElement.textContent = getIndicatorLabel(indicatorData.value);
                    feedbackElement.textContent = indicatorData.feedback || "No recent impact.";
                }
            });
            
            renderFeatures();
        }
        
        function handleOptionHover(effects) {
            // This function now directly manipulates styles for reliability
            for (const key in effects) {
                if (indicators.hasOwnProperty(key)) {
                    const el = document.getElementById(`${key}-indicator-card`);
                    if (el) {
                        // Applying highlight styles directly
                        el.style.borderColor = '#2563eb';
                        el.style.backgroundColor = '#eff6ff';
                        el.style.boxShadow = '0 5px 15px rgba(59, 130, 246, 0.4)';
                    }
                }
            }
        }

        function clearOptionHover() {
            // This function now resets the styles directly
            document.querySelectorAll('.indicator-card').forEach(el => {
                // Resetting to the default styles
                el.style.borderColor = 'transparent';
                el.style.backgroundColor = '#f3f4f6'; // This is the hex for bg-gray-100
                el.style.boxShadow = ''; // This reverts to the default shadow from the 'shadow' class
            });
        }


        function displayCard(card) {
            if (!card) {
                situationText.textContent = "No more situations. Your term is over!";
                option1Button.style.display = 'none';
                option2Button.style.display = 'none';
                messageArea.textContent = "Game Over! Check your final CBDC status.";
                clearOptionHover(); 
                return;
            }
            situationText.textContent = card.situation;
            
            option1Button.textContent = card.options[0].text;
            option1Button.onclick = () => handleOptionClick(0);
            option1Button.onmouseover = () => handleOptionHover(card.options[0].effects);
            option1Button.onmouseout = () => clearOptionHover();
            
            option2Button.textContent = card.options[1].text;
            option2Button.onclick = () => handleOptionClick(1);
            option2Button.onmouseover = () => handleOptionHover(card.options[1].effects);
            option2Button.onmouseout = () => clearOptionHover();

            option1Button.style.display = 'inline-flex'; 
            option2Button.style.display = 'inline-flex';
        }

        function applyEffects(chosenOption) {
            for (const key in indicators) {
                indicators[key].feedback = "";
            }
            // Apply base effects
            for (const effectKey in chosenOption.effects) {
                if (indicators.hasOwnProperty(effectKey)) {
                    indicators[effectKey].value += chosenOption.effects[effectKey];
                    indicators[effectKey].value = Math.max(0, Math.min(indicators[effectKey].value, MAX_INDICATOR_VALUE));
                    if (chosenOption.feedback && chosenOption.feedback.hasOwnProperty(effectKey)) {
                        indicators[effectKey].feedback = chosenOption.feedback[effectKey];
                    } else {
                        const change = chosenOption.effects[effectKey];
                        if (change > 0) indicators[effectKey].feedback = `${indicators[effectKey].name} increased.`;
                        else if (change < 0) indicators[effectKey].feedback = `${indicators[effectKey].name} decreased.`;
                    }
                }
            }
            // Apply conditional effects if any
            if (chosenOption.conditionalEffects) {
                for (const cond of chosenOption.conditionalEffects) {
                    let shouldApply = false;
                    
                    if (cond.condition) {
                        if (cond.condition.chosenKey && chosenOptionKeys.includes(cond.condition.chosenKey)) {
                            shouldApply = true;
                        } else if (cond.condition.notChosenKey && !chosenOptionKeys.includes(cond.condition.notChosenKey)) {
                            shouldApply = true;
                        }
                    }
                    
                    if (shouldApply) {
                        // Check if this is a replacement effect (negative values indicate replacement)
                        const isReplacement = Object.values(cond.effects).some(val => val < 0);
                        
                        for (const effectKey in cond.effects) {
                            if (indicators.hasOwnProperty(effectKey)) {
                                if (isReplacement) {
                                    // Remove the base effect first, then apply conditional effect
                                    if (chosenOption.effects.hasOwnProperty(effectKey)) {
                                        indicators[effectKey].value -= chosenOption.effects[effectKey];
                                    }
                                }
                                indicators[effectKey].value += cond.effects[effectKey];
                                indicators[effectKey].value = Math.max(0, Math.min(indicators[effectKey].value, MAX_INDICATOR_VALUE));
                                // Override base feedback with conditional feedback
                                if (cond.feedback && cond.feedback.hasOwnProperty(effectKey)) {
                                    indicators[effectKey].feedback = cond.feedback[effectKey];
                                }
                            }
                        }
                    }
                }
            }
            for (const key in indicators) {
                if (!chosenOption.effects.hasOwnProperty(key)) {
                    indicators[key].feedback = `No direct impact on ${indicators[key].name} from this decision.`;
                }
            }
        }

        let lastUnlockedFeatureKey = null;
        let lastUnlockedFeatureLabel = null;

        function handleOptionClick(optionIndex) {
            const card = deck[currentCardIndex];
            if (!card) return;
            clearOptionHover();
            const chosenOption = card.options[optionIndex];
            // Track chosen option
            chosenOptions.push({ cardId: card.id, optionIndex: optionIndex });
            // Track achievements
            if (card.id === 25 && optionIndex === 0) achievements.offlineSpace = true;
            if (card.id === 26 && optionIndex === 0) achievements.helicopterMoney = true;
            if (card.id === 2 && optionIndex === 0) achievements.badIdea = true;
            if (card.id === 71 && optionIndex === 0) achievements.nuclearProof = true;
            if (card.id === 66 && optionIndex === 0) achievements.chaosMonkey = true;
            
            // Also check for achievement property in card options
            if (chosenOption.achievement) {
                achievements[chosenOption.achievement] = true;
            }
            // Track chosen option key if present
            let unlockedFeature = null;
            if (chosenOption.chosenKey) {
                chosenOptionKeys.push(chosenOption.chosenKey);
                if (chosenOption.chosenKey === 'programmable_money') features.programmable = true;
                // Check if this is a new feature
                if (!lastUnlockedFeatureKey || !features[lastUnlockedFeatureKey]) {
                    unlockedFeature = chosenOption.chosenKey;
                }
            }
            // Unlock features based on card/option
            if (card.id === 7 && optionIndex === 0 && !features.offline) { features.offline = true; unlockedFeature = 'offline'; }
            if (card.id === 13 && optionIndex === 0 && !features.postquantum) { features.postquantum = true; unlockedFeature = 'postquantum'; }
            if (card.id === 16 && optionIndex === 1 && !features.interoperability) { features.interoperability = true; unlockedFeature = 'interoperability'; }
            if (card.id === 27 && optionIndex === 0 && !features.dispute) { features.dispute = true; unlockedFeature = 'dispute'; }
            if (card.id === 21.5 && optionIndex === 0 && !features.recovery) { features.recovery = true; unlockedFeature = 'recovery'; }
            if (unlockedFeature) {
                lastUnlockedFeatureKey = unlockedFeature;
                // Find label
                const meta = FEATURES_META.find(f => f.key === unlockedFeature);
                lastUnlockedFeatureLabel = meta ? meta.label : unlockedFeature;
            } else {
                lastUnlockedFeatureKey = null;
                lastUnlockedFeatureLabel = null;
            }
            applyEffects(chosenOption);
            let gameOverMessage = "";
            for (const key in indicators) {
                const indicator = indicators[key];
                if (indicator.isGood) {
                    if (indicator.value === 0) {
                        gameOverMessage = `${indicator.name} reached rock bottom (Very Low)! The CBDC project is in peril!`;
                        break;
                    }
                } else {
                    if (indicator.value === MAX_INDICATOR_VALUE) {
                        gameOverMessage = `${indicator.name} is at an EXTREME level! The situation is critical!`;
                        break;
                    }
                }
            }
            if (gameOverMessage) {
                // situationText.textContent = "CRITICAL FAILURE - CBDC Project Terminated"; // Removed redundant message
                option1Button.style.display = 'none';
                option2Button.style.display = 'none';
                // Create detailed game over message
                const failedIndicator = Object.values(indicators).find(indicator => 
                    (indicator.isGood && indicator.value === 0) || 
                    (!indicator.isGood && indicator.value === MAX_INDICATOR_VALUE)
                );
                let detailedMessage = '';
                detailedMessage += `<div style='font-size:1.1rem;line-height:1.3;margin-bottom:0.5em;'><span style='color:#dc2626;font-weight:bold;'>GAME OVER: ${failedIndicator.name} reached rock bottom (Very Low). Public trust has collapsed and the project has been cancelled.</span></div>`;
                detailedMessage += `<div style='font-size:0.95rem;line-height:1.2;margin-bottom:0.2em;'>Cards Completed: <span style='color:#2563eb;font-weight:bold;'>${currentCardIndex + 1}</span></div>`;
                detailedMessage += `<div style='font-size:0.95rem;line-height:1.2;margin-bottom:0.2em;'>Features Unlocked: <span style='color:#22c55e;font-weight:bold;'>${Object.values(features).filter(f => f).length}</span></div>`;
                detailedMessage += `<div style='font-size:0.95rem;line-height:1.2;margin-bottom:0.2em;'>Achievements Earned: <span style='color:#f59e42;font-weight:bold;'>${Object.values(achievements).filter(a => a).length}</span></div>`;
                detailedMessage += `<div style='font-size:0.9rem;line-height:1.2;margin-top:0.3em;'>Tip: Try different strategies to avoid this failure condition!</div>`;
                messageArea.innerHTML = detailedMessage;
                renderIndicators();
                return;
            }
            if (currentCardIndex >= deck.length - 1) {
                situationText.textContent = "üéâ CONGRATULATIONS - CBDC Project Successfully Completed! üéâ";
                option1Button.style.display = 'none';
                option2Button.style.display = 'none';
                
                // Calculate performance metrics
                const avgIndicatorValue = Object.values(indicators).reduce((sum, ind) => sum + ind.value, 0) / 6;
                const highIndicators = Object.values(indicators).filter(ind => ind.value >= 4).length;
                const lowIndicators = Object.values(indicators).filter(ind => ind.value <= 2).length;
                const featuresUnlocked = Object.values(features).filter(f => f).length;
                const achievementsEarned = Object.values(achievements).filter(a => a).length;
                
                // Determine performance rating
                let performanceRating = "üü¢ EXCELLENT";
                let ratingDescription = "Outstanding leadership! Your CBDC is a model for the world.";
                if (avgIndicatorValue < 2.5 || lowIndicators >= 3) {
                    performanceRating = "üî¥ POOR";
                    ratingDescription = "The CBDC project survived but with significant challenges.";
                } else if (avgIndicatorValue < 3.5 || highIndicators < 2) {
                    performanceRating = "üü° ADEQUATE";
                    ratingDescription = "Solid performance with room for improvement.";
                } else if (avgIndicatorValue < 4.5) {
                    performanceRating = "üü† GOOD";
                    ratingDescription = "Strong leadership with good results.";
                }
                
                let victoryMessage = `üéâ CONGRATULATIONS! You successfully handled ${deck.length} of 75 total scenarios as CBDC Chief!<br><br>`;
                victoryMessage += `You unlocked <span style='color:#22c55e;font-weight:bold;'>${featuresUnlocked}</span> of the 6 CBDC features and reached <span style='color:#f59e42;font-weight:bold;'>${achievementsEarned}</span> of the 5 achievements!<br><br>`;
                victoryMessage += `üèÜ Performance Rating: ${performanceRating}<br>`;
                victoryMessage += `${ratingDescription}<br><br>`;
                victoryMessage += `üìà Final Statistics:<br>`;
                victoryMessage += `‚Ä¢ Average Indicator Level: ${avgIndicatorValue.toFixed(1)}/5<br>`;
                victoryMessage += `‚Ä¢ High-Performing Indicators: ${highIndicators}/6<br>`;
                victoryMessage += `‚Ä¢ Features Implemented: <span style='color:#22c55e;font-weight:bold;'>${featuresUnlocked}</span>/6<br>`;
                victoryMessage += `‚Ä¢ Achievements Unlocked: <span style='color:#f59e42;font-weight:bold;'>${achievementsEarned}</span>/5<br><br>`;
                // Add feature summary
                if (featuresUnlocked > 0) {
                    victoryMessage += `\nüîß Features Implemented:<br>`;
                    Object.entries(features).forEach(([key, implemented]) => {
                        if (implemented) {
                            const meta = FEATURES_META.find(f => f.key === key);
                            victoryMessage += `‚úÖ ${meta ? meta.label : key}<br>`;
                        }
                    });
                }
                // Add achievement summary
                if (achievementsEarned > 0) {
                    victoryMessage += `\nüèÖ Achievements Earned:<br>`;
                    if (achievements.offlineSpace) victoryMessage += `üöÄ Offline in Outer Space<br>`;
                    if (achievements.helicopterMoney) victoryMessage += `üí∏ Helicopter Money<br>`;
                    if (achievements.badIdea) victoryMessage += `üíÄ Bad Idea<br>`;
                    if (achievements.nuclearProof) victoryMessage += `‚ò¢Ô∏è Nuclear Proof<br>`;
                    if (achievements.chaosMonkey) victoryMessage += `üêí Chaos Monkey<br>`;
                }
                victoryMessage += `\nüéØ Challenge completed! Your CBDC legacy is secure.`;
                messageArea.innerHTML = victoryMessage;
                renderIndicators();
                return;
            }
            drawNextCard();
            renderIndicators();
            renderAchievements();
        }

        function drawNextCard() {
            currentCardIndex++;
            if (currentCardIndex < deck.length) {
                const card = deck[currentCardIndex];
                playedCardIds.push(card.id);
                displayCard(card);
            } else {
                displayCard(null);
            }
        }
        
        function setManagerName() { 
             characterNameElement.textContent = `Manager Von Tokenstrudel, CBDC Chief`; 
        }

        function initializeGame() {
            indicators = {
                usage: { name: "Usage", value: 3, isGood: true, barFillClass: 'usage-bar-fill', feedback: "System launched. Current usage: Medium." },
                resilience: { name: "Resilience", value: 3, isGood: true, barFillClass: 'resilience-bar-fill', feedback: "System stable. Current resilience: Medium." },
                security: { name: "Security", value: 3, isGood: true, barFillClass: 'security-bar-fill', feedback: "Initial security levels nominal. Current security: Medium." },
                budget: { name: "Budget", value: 3, isGood: true, barFillClass: 'budget-bar-fill', feedback: "Operational budget at baseline. Current budget: Medium." },
                privacy: { name: "Privacy", value: 3, isGood: true, barFillClass: 'privacy-bar-fill', feedback: "User privacy is stable. Current privacy: Medium." },
                reputation: { name: "Reputation", value: 3, isGood: true, barFillClass: 'reputation-bar-fill', feedback: "Public perception is neutral. Current reputation: Medium." }
            };
            currentCardIndex = -1;
            messageArea.textContent = "";
            playedCardIds = [];
            chosenOptionKeys = [];
            chosenOptions = [];
            features = { 
                offline: false, 
                postquantum: false, 
                interoperability: false, 
                dispute: false, 
                programmable: false, 
                recovery: false,
                fraud_scoring_tool: false,
                crypto_postquantum: false,
                crypto_cheap: false,
                offline_invest: false,
                offline_delay: false,
                programmable_money: false
            };
            achievements = { offlineSpace: false, helicopterMoney: false, badIdea: false, nuclearProof: false, chaosMonkey: false };
            deck = buildDeckWithPrerequisites(cardsData);
            setManagerName();
            renderIndicators();
            drawNextCard();
            option1Button.style.display = 'inline-flex';
            option2Button.style.display = 'inline-flex';
            situationText.classList.remove('text-red-500');
            renderAchievements();
        }
        
        restartButton.addEventListener('click', initializeGame);

        // --- START GAME ---
        document.addEventListener('DOMContentLoaded', initializeGame);

        function renderFeatures() {
            featuresList.innerHTML = '';
            let count = 0;
            for (const meta of FEATURES_META) {
                if (!features[meta.key]) continue; // Only show implemented features
                const li = document.createElement('li');
                li.className = 'flex items-center gap-2 px-2 py-1 rounded bg-indigo-100 text-indigo-900 text-sm font-semibold w-full border border-indigo-400';
                const icon = document.createElement('span');
                icon.className = 'text-lg font-bold';
                icon.textContent = meta.icon || '‚úî';
                li.appendChild(icon);
                const label = document.createElement('span');
                label.textContent = meta.label;
                li.appendChild(label);
                featuresList.appendChild(li);
                count++;
            }
            if (count === 0) {
                const li = document.createElement('li');
                li.className = 'text-gray-400 text-sm text-center w-full whitespace-nowrap';
                li.textContent = 'No CBDC features unlocked yet.';
                featuresList.appendChild(li);
            }
            // Show feedback if a new feature was just unlocked
            if (lastUnlockedFeatureLabel) {
                featuresGoal.textContent = `You have unlocked ${lastUnlockedFeatureLabel}. This action will have consequences...`;
            } else {
                featuresGoal.textContent = '';
            }
        }

        function renderAchievements() {
            const achievementsList = document.getElementById('achievements-list');
            if (!achievementsList) return;
            achievementsList.innerHTML = '';
            let unlocked = 0;
            if (achievements.offlineSpace) {
                const li = document.createElement('li');
                li.className = 'flex items-center gap-2 px-2 py-1 rounded bg-indigo-100 text-indigo-900 text-sm font-semibold w-full border border-indigo-400';
                li.innerHTML = '<span class="text-xl">üöÄ</span>Offline in Outer Space';
                achievementsList.appendChild(li);
                unlocked++;
            }
            if (achievements.helicopterMoney) {
                const li = document.createElement('li');
                li.className = 'flex items-center gap-2 px-2 py-1 rounded bg-indigo-100 text-indigo-900 text-sm font-semibold w-full border border-indigo-400';
                li.innerHTML = '<span class="text-xl">üí∏</span>Helicopter Money';
                achievementsList.appendChild(li);
                unlocked++;
            }
            if (achievements.badIdea) {
                const li = document.createElement('li');
                li.className = 'flex items-center gap-2 px-2 py-1 rounded bg-indigo-100 text-indigo-900 text-sm font-semibold w-full border border-indigo-400';
                li.innerHTML = '<span class="text-xl">üíÄ</span>Bad Idea';
                achievementsList.appendChild(li);
                unlocked++;
            }
            if (achievements.nuclearProof) {
                const li = document.createElement('li');
                li.className = 'flex items-center gap-2 px-2 py-1 rounded bg-indigo-100 text-indigo-900 text-sm font-semibold w-full border border-indigo-400';
                li.innerHTML = '<span class="text-xl">‚ò¢Ô∏è</span>Nuclear Proof';
                achievementsList.appendChild(li);
                unlocked++;
            }
            if (achievements.chaosMonkey) {
                const li = document.createElement('li');
                li.className = 'flex items-center gap-2 px-2 py-1 rounded bg-indigo-100 text-indigo-900 text-sm font-semibold w-full border border-indigo-400';
                li.innerHTML = '<span class="text-xl">üêí</span>Chaos Monkey';
                achievementsList.appendChild(li);
                unlocked++;
            }
            if (unlocked === 0) {
                const li = document.createElement('li');
                li.className = 'text-gray-400 text-sm text-center w-full';
                li.textContent = 'No achievements unlocked yet.';
                achievementsList.appendChild(li);
            }
        }

    </script>
</body>
</html>

</html>
